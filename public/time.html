<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>User Event Timeline</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    select {
      padding: 6px;
      margin-bottom: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #f0f0f0;
    }
    .session-ended {
      color: red;
      font-weight: bold;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .loading {
      font-style: italic;
      color: gray;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>User Event Timeline</h2>

<label for="userSelect">Select User:</label>
<select id="userSelect">
  <option value="">-- Select a User --</option>
</select>

<p id="statusMessage" class="loading">Loading data...</p>

<table id="timelineTable" style="display:none;">
  <thead>
    <tr>
      <th>Time Stamp</th>
      <th>Event Type</th>
      <th>Event Number</th>
      <th>Payload</th>
      <th>Time Spent (minutes)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const userSelect = document.getElementById("userSelect");
const timelineTable = document.getElementById("timelineTable");
const timelineTableBody = timelineTable.querySelector("tbody");
const statusMessage = document.getElementById("statusMessage");

let timelineData = [];

/* ---------- Helpers ---------- */
function safeDate(value) {
  if (!value) return "N/A";
  const d = new Date(value);
  return isNaN(d.getTime()) ? "N/A" : d.toLocaleString();
}

function safeJSON(obj) {
  try {
    return JSON.stringify(obj ?? {}, null, 2);
  } catch {
    return "{}";
  }
}

function formatTimeSpent(value) {
  if (value === "session ended") return "session ended";
  if (typeof value === "number") return value.toFixed(2);
  return "N/A";
}

/* ---------- Fetch Users ---------- */
async function fetchUsers() {
  try {
    const res = await fetch("/users");
    if (!res.ok) throw new Error();
    const users = await res.json();
    if (!Array.isArray(users) || users.length === 0) {
      statusMessage.textContent = "No users found.";
      return;
    }
    users.forEach(user => {
      const option = document.createElement("option");
      option.value = user ?? "unknown";
      option.textContent = user ?? "unknown";
      userSelect.appendChild(option);
    });
  } catch {
    statusMessage.textContent = "Error loading users.";
    statusMessage.className = "error";
  }
}

/* ---------- Fetch Timeline ---------- */
async function fetchTimeline() {
  try {
    const res = await fetch("/time");
    if (!res.ok) throw new Error();
    const data = await res.json();
    if (!Array.isArray(data)) throw new Error("Invalid data");

    // Sort timeline by timestamp, then event_number
    timelineData = data.sort((a, b) => {
      const ta = a.time_stamp ? new Date(a.time_stamp).getTime() : 0;
      const tb = b.time_stamp ? new Date(b.time_stamp).getTime() : 0;
      return ta - tb || (a.event_number - b.event_number);
    });

    statusMessage.style.display = "none";
    timelineTable.style.display = "table";
  } catch {
    statusMessage.textContent = "Error loading timeline data.";
    statusMessage.className = "error";
  }
}

/* ---------- Render Timeline ---------- */
function renderTimeline(user) {
  timelineTableBody.innerHTML = "";
  if (!user) return;

  const events = timelineData.filter(e => (e.user_name ?? "unknown") === user);

  if (events.length === 0) {
    timelineTableBody.innerHTML = `
      <tr>
        <td colspan="5">No events found for this user.</td>
      </tr>
    `;
    return;
  }

  for (let i = 0; i < events.length; i++) {
    const event = events[i];
    let timeDisplay = "N/A";

    if (event.time_spent !== undefined && event.time_spent !== null) {
      timeDisplay = formatTimeSpent(event.time_spent);
    }

    const isSessionEnd = timeDisplay === "session ended";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${safeDate(event.time_stamp)}</td>
      <td>${event.event_type ?? "unknown"}</td>
      <td>${event.event_number ?? "N/A"}</td>
      <td><pre>${safeJSON(event.payload)}</pre></td>
      <td class="${isSessionEnd ? "session-ended" : ""}">${timeDisplay}</td>
    `;
    timelineTableBody.appendChild(row);
  }
}

/* ---------- Events ---------- */
userSelect.addEventListener("change", () => {
  renderTimeline(userSelect.value);
});

/* ---------- Init ---------- */
(async function init() {
  await fetchUsers();
  await fetchTimeline();
})();
</script>

</body>
</html>
