<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GraspGUI Clicks by Selection</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    overflow-x: auto; /* allow scroll if many users */
  }

  table {
    border-collapse: collapse;
    width: auto;              /* content decides width */
    text-align: center;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 6px 10px;
    vertical-align: middle;
    white-space: nowrap;      /* fit content */
  }

  th {
    background-color: #f0f0f0;
  }

  .chart-container {
    width: 90px;
    height: 90px;
    display: block;
    margin: auto;
  }

  .legend {
    margin: 20px 0;
  }

  .legend-item {
    display: inline-block;
    margin-right: 15px;
  }

  .legend-color {
    width: 15px;
    height: 15px;
    display: inline-block;
    margin-right: 5px;
    vertical-align: middle;
  }
</style>
</head>

<body>

<h1>GraspGUI Clicks by Selection</h1>

<div class="legend" id="legend"></div>

<table id="bigTable">
  <thead>
    <tr id="chartRow">
      <th>Selection</th>
    </tr>
    <tr id="labelRow">
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function loadData() {
  const res = await fetch('/graspStart');
  const data = await res.json();

  const users = Object.keys(data.perUser).sort();
  const selections = data.averages.map(a => a.selection);

  const table = document.getElementById('bigTable');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  thead.innerHTML = '';
  tbody.innerHTML = '';

  const colors = [
    '#4caf50', '#2196f3', '#ff9800', '#f44336',
    '#9c27b0', '#00bcd4', '#ffeb3b', '#795548'
  ];

  /* ---------- HEADER ---------- */
  const headerRow = document.createElement('tr');
  headerRow.appendChild(Object.assign(document.createElement('th'), { textContent: 'User' }));
  selections.forEach(sel => {
    const th = document.createElement('th');
    th.textContent = sel;
    headerRow.appendChild(th);
  });
  const pieTh = document.createElement('th');
  pieTh.textContent = 'Distribution';
  headerRow.appendChild(pieTh);
  thead.appendChild(headerRow);

  /* ---------- AVERAGE ROW (TOP) ---------- */
  const trAvg = document.createElement('tr');
  const tdLabel = document.createElement('td');
  tdLabel.textContent = 'Average';
  tdLabel.style.fontWeight = 'bold';
  trAvg.appendChild(tdLabel);

  const avgData = selections.map(sel => {
    const avgObj = data.averages.find(a => a.selection === sel);
    const val = avgObj ? avgObj.avg_clicks_per_user : 0;
    const td = document.createElement('td');
    td.textContent = val.toFixed(2);
    trAvg.appendChild(td);
    return val;
  });

  /* ---------- Average Pie Chart ---------- */
  const tdAvgPie = document.createElement('td');
  const avgCanvas = document.createElement('canvas');
  avgCanvas.width = 80;
  avgCanvas.height = 80;
  tdAvgPie.appendChild(avgCanvas);
  trAvg.appendChild(tdAvgPie);

  new Chart(avgCanvas, {
    type: 'pie',
    data: {
      labels: selections,
      datasets: [{
        data: avgData,
        backgroundColor: selections.map((_, i) => colors[i % colors.length])
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: true,
      plugins: { legend: { display: false } },
      animation: { duration: 0 }
    }
  });

  tbody.appendChild(trAvg);

  /* ---------- PER-USER ROWS ---------- */
  users.forEach(user => {
    const tr = document.createElement('tr');

    const tdUser = document.createElement('td');
    tdUser.textContent = user;
    tr.appendChild(tdUser);

    // --- Compute max for this row ---
    const userValues = selections.map(sel => {
      const obj = data.perUser[user].find(s => s.selection === sel);
      return obj ? obj.clicks : 0;
    });
    const rowMax = Math.max(...userValues, 1); // avoid division by zero

    // --- Fill user cells with heatmap ---
    userValues.forEach((clicks, idx) => {
      const td = document.createElement('td');
      td.textContent = clicks;

      // --- Heatmap: white → light green → dark green ---
      const intensity = clicks / rowMax; // 0 → 1 for this row
      let r, g, b;
      if (intensity < 0.5) {
        const t = intensity / 0.5;
        r = Math.round(255 - t * (255 - 220));
        g = Math.round(255 - t * (255 - 255));
        b = Math.round(255 - t * (255 - 220));
      } else {
        const t = (intensity - 0.5) / 0.5;
        r = Math.round(220 - t * (220 - 50));
        g = Math.round(255 - t * (255 - 150));
        b = Math.round(220 - t * (220 - 50));
      }
      td.style.backgroundColor = `rgb(${r},${g},${b})`;
      td.style.color = 'black';
      tr.appendChild(td);
    });

    /* ---------- Pie chart per user ---------- */
    const tdPie = document.createElement('td');
    const canvas = document.createElement('canvas');
    canvas.width = 80;
    canvas.height = 80;
    tdPie.appendChild(canvas);
    tr.appendChild(tdPie);

    new Chart(canvas, {
      type: 'pie',
      data: {
        labels: selections,
        datasets: [{
          data: userValues,
          backgroundColor: selections.map((_, i) => colors[i % colors.length])
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: true,
        plugins: { legend: { display: false } },
        animation: { duration: 0 }
      }
    });

    tbody.appendChild(tr);
  });
}
loadData();
</script>


</body>
</html>
