<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Session Viewer</title>
<link rel="stylesheet" href="styles/styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="scripts/utils.js"></script>
</head>
<body>

<header>
    <div class="navbar">
        <a href="index.html"><img src="images/ticra.png" alt="Home" class="nav-icon"></a>
        <a href="data.html">Datapool</a>
    </div>
</header>

<h1>Session Viewer</h1>

<form id="sessionForm">
  <label>Event Type:
    <select id="eventTypeSelect"><option value="">Select Event Type</option></select>
  </label>

  <label>Employee:
    <select id="employeeSelect"><option value="">All</option></select>
  </label>

  <label>Start Time:
    <input type="datetime-local" id="startTime">
  </label>

  <label>End Time:
    <input type="datetime-local" id="endTime">
  </label>

  <button type="submit">Apply</button>
</form>

<div id="tableContainer"></div>

<div id="totalChartContainer" class="chart-container">
  <canvas id="totalChart"></canvas>
</div>

<script type="module">
import { 
    setDefaultDateRange, fetchJson, createHeader, createCell, applyHeatmap, 
    sortTableByRow, renderBarChart, populateDropdown 
} from './scripts/utils.js';

const eventTypeSelect = document.getElementById("eventTypeSelect");
const employeeSelect = document.getElementById("employeeSelect");
const startInput = document.getElementById("startTime");
const endInput = document.getElementById("endTime");
const form = document.getElementById("sessionForm");
const tableContainer = document.getElementById("tableContainer");
const totalChartCanvas = document.getElementById("totalChart");
let sortState = {};


setDefaultDateRange('startTime','endTime',10);

async function initDropdownsAndLoad() {
    await populateDropdown('eventTypeSelect','/sessionTypes','Select Event Type');
    await populateDropdown('employeeSelect','/users','All');
    fetchSessions();
}

initDropdownsAndLoad();


form.addEventListener('submit', e=>{
    e.preventDefault();
    fetchSessions();
});


async function fetchSessions(){
    const selectedEvent = eventTypeSelect.value;
    if(!selectedEvent) return;

    const selectedUser = employeeSelect.value || null;
    let url = `/session?eventType=${encodeURIComponent(selectedEvent)}&startTime=${encodeURIComponent(startInput.value)}&endTime=${encodeURIComponent(endInput.value)}`;
    if(selectedUser) url += `&user_name=${encodeURIComponent(selectedUser)}`;

    const data = await fetchJson(url);
    const sessions = data.sessions || [];

    const perEmployee = {};
    if(!selectedUser){
        sessions.forEach(s=>{
            const user = s.user_name || "Unknown";
            if(!perEmployee[user]) perEmployee[user] = [];
            perEmployee[user].push(s);
        });
    } else {
        perEmployee[selectedUser] = sessions;
    }

    renderTable(perEmployee);
    renderChart(perEmployee);
}

// ----------------- TABLE -----------------
function renderTable(perEmployee){
    tableContainer.innerHTML = "";
    const selectedUser = employeeSelect.value || null;

    if(!selectedUser) renderMultiUserTable(perEmployee);
    else renderSingleUserTable(perEmployee[selectedUser]);

    applyHeatmap("#tableContainer table");
}

function createRotatedHeader(text){
    const th = document.createElement("th");
    th.classList.add("rotate");
    const div = document.createElement("div");
    div.textContent = text;
    th.appendChild(div);
    return th;
}

function renderMultiUserTable(perEmployee){
    const allTabs = [...new Set(Object.values(perEmployee).flatMap(sess => sess.map(s => s.tab)))].sort();
    const employeeNames = Object.keys(perEmployee).sort();
    if(!allTabs.length || !employeeNames.length){
        tableContainer.innerHTML="<p>No sessions found.</p>"; 
        return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    // Header
    const headerRow = document.createElement("tr");
    headerRow.appendChild(createHeader("Tab"));
    employeeNames.forEach(u => headerRow.appendChild(createRotatedHeader(u)));
    ["TOTAL","AVERAGE"].forEach(label => headerRow.appendChild(createRotatedHeader(label)));
    thead.appendChild(headerRow);

    // Rows
    allTabs.forEach(tab=>{
        const tr = document.createElement("tr");
        tr.dataset.tab = tab;
        tr.classList.add('sortable');
        tr.appendChild(createCell(tab));

        let total=0;
        employeeNames.forEach(u=>{
            const val = perEmployee[u].find(s=>s.tab===tab)?.durationSeconds||0;
            total+=val;
            tr.appendChild(createCell(Math.round(val)));
        });
        tr.appendChild(createCell(Math.round(total),true));
        tr.appendChild(createCell((total/employeeNames.length).toFixed(2),true));

        tbody.appendChild(tr);
        tr.addEventListener('click', ()=>sortTableByRow(table,tr,sortState));
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    tableContainer.appendChild(table);
}

function renderSingleUserTable(sessions){
    const sessionIds = [...new Set(sessions.map(s=>s.session_id))].sort();
    const tabs = [...new Set(sessions.map(s=>s.tab))].sort();
    if(!sessions.length){
        tableContainer.innerHTML="<p>No sessions found for this employee.</p>"; 
        return;
    }

    const table = document.createElement("table");
    const thead = document.createElement("thead");
    const tbody = document.createElement("tbody");

    // Header
    const headerRow = document.createElement("tr");
    headerRow.appendChild(createHeader("Tab"));
    sessionIds.forEach(id => headerRow.appendChild(createRotatedHeader(id)));
    ["TOTAL","AVERAGE"].forEach(label => headerRow.appendChild(createRotatedHeader(label)));
    thead.appendChild(headerRow);

    // Rows
    tabs.forEach(tab=>{
        const tr = document.createElement("tr");
        tr.dataset.tab = tab;
        tr.appendChild(createCell(tab));

        let total=0;
        sessionIds.forEach(id=>{
            const val = sessions.find(s=>s.tab===tab && s.session_id===id)?.durationSeconds||0;
            total+=val;
            tr.appendChild(createCell(Math.round(val)));
        });
        tr.appendChild(createCell(Math.round(total),true));
        tr.appendChild(createCell((total/sessionIds.length).toFixed(2),true));

        tbody.appendChild(tr);
        tr.addEventListener('click', ()=>sortTableByRow(table,tr,sortState));
    });

    table.appendChild(thead);
    table.appendChild(tbody);
    tableContainer.appendChild(table);
}

// ----------------- CHART -----------------
function renderChart(perEmployee){
    const selectedUser = employeeSelect.value || null;
    let labels=[], totals=[];
    if(!selectedUser){
        const tabs = [...new Set(Object.values(perEmployee).flatMap(sess => sess.map(s => s.tab)))].sort();
        labels = tabs;
        totals = tabs.map(tab => Object.keys(perEmployee).reduce((sum,user) => sum + (perEmployee[user].find(s=>s.tab===tab)?.durationSeconds||0),0));
    } else {
        const sessions = perEmployee[selectedUser];
        const tabs = [...new Set(sessions.map(s=>s.tab))].sort();
        labels = tabs;
        totals = tabs.map(tab=>sessions.filter(s=>s.tab===tab).reduce((sum,s)=>sum+s.durationSeconds,0));
    }

    // Random colors per bar
    const colors = labels.map(_=>`rgb(${Math.random()*200},${Math.random()*200},${Math.random()*200})`);

    renderBarChart(totalChartCanvas, labels, totals, colors, {
        responsive:true,
        plugins:{
            legend:{display:false},
            title:{display:true,text:'Total Duration per Tab'}
        },
        scales:{y:{beginAtZero:true}}
    });
}
</script>

<footer>
    Â© TICRA foundation
</footer>
</body>
</html>
