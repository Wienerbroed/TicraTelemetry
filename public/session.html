<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Employee Sessions</title>
  <link rel="stylesheet" href="styles/styles.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    input, select { padding: 5px; margin-right: 10px; }
    button { padding: 5px 10px; }
    .session-header { background: #eee; font-weight: bold; margin-top: 20px; padding: 5px; }
  </style>
</head>
<body>
  <h1>Employee Sessions</h1>

  <form id="sessionForm">
    <label>Employee:
      <select id="employeeSelect">
        <option value="">All</option>
      </select>
    </label>
    <label>Start Time: <input type="datetime-local" id="startTime"></label>
    <label>End Time: <input type="datetime-local" id="endTime"></label>
    <button type="submit">Fetch Sessions</button>
  </form>

  <div id="sessionsContainer"></div>

  <script>
    const startInput = document.getElementById("startTime");
    const endInput = document.getElementById("endTime");
    const form = document.getElementById("sessionForm");
    const employeeSelect = document.getElementById("employeeSelect");
    const container = document.getElementById("sessionsContainer");

    // Set default time: now and 10 days back
    const now = new Date();
    const tenDaysAgo = new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000);

    function formatDateTimeLocal(date) {
      const pad = n => n.toString().padStart(2, '0');
      const yyyy = date.getFullYear();
      const mm = pad(date.getMonth() + 1);
      const dd = pad(date.getDate());
      const hh = pad(date.getHours());
      const min = pad(date.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
    }

    startInput.value = formatDateTimeLocal(tenDaysAgo);
    endInput.value = formatDateTimeLocal(now);

    // Load all users into dropdown
    async function loadUsers() {
      try {
        const res = await fetch("/users");
        const users = await res.json();
        users.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          employeeSelect.appendChild(option);
        });
      } catch (err) {
        console.error("Error fetching users:", err);
      }
    }

    // Fetch sessions from backend
    async function fetchSessions(startTime, endTime, userName = "") {
      try {
        let url = `/seesion?startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
        if (userName) url += `&user_name=${encodeURIComponent(userName)}`;
        const res = await fetch(url);
        return await res.json(); // expects { sessions: [...], averages: {...} }
      } catch (err) {
        console.error("Error fetching sessions:", err);
        return { sessions: [], averages: {} };
      }
    }

    // Render sessions and averages
    function renderTables(data) {
      container.innerHTML = "";

      const { sessions, averages } = data;

      // Render top tables with averages per employee
      Object.entries(averages).forEach(([user, tabAvgs]) => {
        const header = document.createElement("div");
        header.classList.add("session-header");
        header.textContent = `Average Time per Tab - Employee: ${user}`;
        container.appendChild(header);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>Tab</th>
            <th>Average Time (Seconds)</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        Object.entries(tabAvgs).forEach(([tab, avgMs]) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${tab}</td><td>${Math.round(avgMs)}</td>`;
          tbody.appendChild(row);
        });
        table.appendChild(tbody);
        container.appendChild(table);
      });

      // Group session segments by user
      const byUser = {};
      sessions.forEach(item => {
        if (!byUser[item.user_name]) byUser[item.user_name] = [];
        byUser[item.user_name].push(item);
      });

      // Render session tables
      Object.entries(byUser).forEach(([user, sessionEvents]) => {
        // Group by session_id
        const bySession = {};
        sessionEvents.forEach(item => {
          if (!bySession[item.session_id]) bySession[item.session_id] = [];
          bySession[item.session_id].push(item);
        });

        // Sort sessions (tables) by first event start_time descending
        const sortedSessions = Object.entries(bySession).sort(
          ([, segA], [, segB]) => new Date(segB[0].start_time) - new Date(segA[0].start_time)
        );

        sortedSessions.forEach(([sessionId, sessionSegs]) => {
          // Keep sessionSegs in chronological order (earliest â†’ latest)
          sessionSegs.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

          const header = document.createElement("div");
          header.classList.add("session-header");
          header.textContent = `Employee: ${user} | Session ID: ${sessionId}`;
          container.appendChild(header);

          const table = document.createElement("table");
          const thead = document.createElement("thead");
          thead.innerHTML = `
            <tr>
              <th>Selected Tab</th>
              <th>Start Time</th>
              <th>Duration (Seconds)</th>
            </tr>`;
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          sessionSegs.forEach(item => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${item.tab}</td>
              <td>${new Date(item.start_time).toLocaleString('da-DK', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
              })}</td>
              <td>${Math.round(item.durationSeconds)}</td>
            `;
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          container.appendChild(table);
        });
      });
    }

    // Form submit
    form.addEventListener("submit", async e => {
      e.preventDefault();
      const startTime = startInput.value;
      const endTime = endInput.value;
      const userName = employeeSelect.value;
      const data = await fetchSessions(startTime, endTime, userName);
      renderTables(data);
    });

    // Initial load
    loadUsers();
    fetchSessions(startInput.value, endInput.value).then(renderTables);
  </script>
</body>
</html>
