<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Event Time Analytics</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f6f7f9;
        padding: 24px;
    }

    h1 {
        margin-bottom: 8px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
    }

    th, td {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        text-align: center;
        vertical-align: top;
    }

    th {
        background: #f0f0f0;
    }

    td:first-child,
    th:first-child {
        text-align: left;
        font-weight: bold;
    }

    canvas {
        display: block;
        margin: 6px auto 4px;
    }

    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 16px 0;
    }

    .legend-item {
        display: flex;
        align-items: center;
        font-size: 13px;
    }

    .legend-color {
        width: 14px;
        height: 14px;
        margin-right: 6px;
        border-radius: 3px;
    }

    .muted {
        color: #aaa;
    }
</style>
</head>
<body>

<h1>Time Spent by Event Type</h1>
<p>Pies show % distribution • Cell color = relative time in that column</p>

<div id="legend" class="legend"></div>

<table id="table"></table>

<script>
const COLORS = [
    "#4CAF50", "#2196F3", "#FFC107",
    "#E91E63", "#9C27B0", "#00BCD4",
    "#FF5722", "#795548"
];

async function loadData() {
    const res = await fetch("/pool");
    const data = await res.json();

    const averages = data.averages;
    const perUserRaw = data.perUser;
    const users = Object.keys(perUserRaw);

    // -------- aggregate per user by event_type
    const perUser = {};
    users.forEach(u => {
        perUser[u] = {};
        perUserRaw[u].forEach(r => {
            perUser[u][r.event_type] =
                (perUser[u][r.event_type] || 0) + r.time_spent;
        });
    });

    // -------- collect all event types
    const eventTypes = Array.from(new Set([
        ...averages.map(a => a.event_type),
        ...users.flatMap(u => Object.keys(perUser[u]))
    ]));

    // -------- color map
    const colorMap = {};
    eventTypes.forEach((e, i) => colorMap[e] = COLORS[i % COLORS.length]);

    renderLegend(eventTypes, colorMap);
    renderTable(eventTypes, averages, users, perUser, colorMap);
}

// ================= LEGEND =================
function renderLegend(eventTypes, colorMap) {
    const legend = document.getElementById("legend");
    eventTypes.forEach(e => {
        const item = document.createElement("div");
        item.className = "legend-item";
        item.innerHTML = `
            <div class="legend-color" style="background:${colorMap[e]}"></div>
            ${e}
        `;
        legend.appendChild(item);
    });
}

// ================= TABLE =================
function renderTable(eventTypes, averages, users, perUser, colorMap) {
    const table = document.getElementById("table");

    // ----- column data for color normalization
    const columns = {
        average: averages.reduce((a, r) => {
            a[r.event_type] = r.avg_time_spent;
            return a;
        }, {})
    };

    users.forEach(u => columns[u] = perUser[u]);

    // ----- header
    let thead = `<thead><tr><th>Event Type</th>`;
    thead += renderHeaderCell("Average", columns.average, colorMap);
    users.forEach(u => thead += renderHeaderCell(u, columns[u], colorMap));
    thead += `</tr></thead>`;

    // ----- body
    let tbody = `<tbody>`;

    eventTypes.forEach(et => {
        tbody += `<tr><td>${et}</td>`;

        Object.keys(columns).forEach(col => {
            const value = columns[col][et] || 0;
            const max = Math.max(...Object.values(columns[col]), 1);
            const intensity = value / max;

            const bg = `rgba(76, 175, 80, ${intensity * 0.6})`;

            tbody += `
                <td style="background:${value ? bg : "transparent"}"
                    class="${value ? "" : "muted"}">
                    ${value ? value.toFixed(2) : "—"}
                </td>
            `;
        });

        tbody += `</tr>`;
    });

    tbody += `</tbody>`;
    table.innerHTML = thead + tbody;
}

// ================= PIE IN HEADER =================
function renderHeaderCell(title, data, colorMap) {
    const canvasId = `pie-${Math.random().toString(36).slice(2)}`;

    setTimeout(() => drawPie(canvasId, data, colorMap), 0);

    return `
        <th>
            ${title}
            <canvas id="${canvasId}" width="90" height="90"></canvas>
        </th>
    `;
}

function drawPie(id, data, colorMap) {
    const canvas = document.getElementById(id);
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    const total = Object.values(data).reduce((s, v) => s + v, 0);

    let angle = 0;
    Object.entries(data).forEach(([key, value]) => {
        const slice = total === 0 ? 0 : value / total;
        const next = angle + slice * Math.PI * 2;

        ctx.beginPath();
        ctx.moveTo(45, 45);
        ctx.arc(45, 45, 40, angle, next);
        ctx.fillStyle = colorMap[key];
        ctx.fill();

        angle = next;
    });
}

loadData();
</script>

</body>
</html>
