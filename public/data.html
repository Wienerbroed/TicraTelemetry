<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Pool Viewer</title>
<link rel="stylesheet" href="styles/styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="scripts/utils.js"></script>
</head>
<body>

<header>
    <div class="navbar">
        <a href="index.html"><img src="images/ticra.png" alt="Home" class="nav-icon"></a>
        <a href="session.html">Sessions</a>
    </div>
</header>

<h1>Event Pool Viewer</h1>

<div id="filters">
    <div>
        <label>Start date:
            <input type="date" id="startDate">
        </label>
        <label>End date:
            <input type="date" id="endDate">
        </label>
        <button id="applyButton">Apply</button>
    </div>

    <div>
        <strong>Event types:</strong>
        <div id="eventTypeGroup" class="checkbox-group"></div>
    </div>

    <div>
        <strong>Employee types:</strong>
        <div id="employeeTypeGroup" class="checkbox-group"></div>
    </div>

</div>

<div id="tableContainerWrapper">
    <div id="tableContainer">
        <table id="bigTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="multiChartContainer"></div>

<footer>
    Â© TICRA foundation
</footer>

<script type="module">
import { COLORS, setDefaultDateRange, fetchJson, createCell, sortTableByRow, renderMultipleBarCharts, applyStickyColumns } from './scripts/utils.js';

const STATE = {
    fullEvents: [],
    activeUsers: [],
    userOrder: [],
    rowSortStates: {},
    eventTypeOrder: [],
    allEmployeeTypes: []
};

setDefaultDateRange('startDate','endDate',10);

// ------------------------
// LOAD FILTER CHECKBOXES
// ------------------------
async function loadEventTypes() {
    const data = await fetchJson('/eventQueries');
    const container = document.getElementById('eventTypeGroup');
    container.innerHTML = '';
    data.forEach(ev => {
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = ev;
        input.checked = true;
        label.appendChild(input);
        label.appendChild(document.createTextNode(ev));
        container.appendChild(label);
    });
}

async function loadEmployeeTypes() {
    const data = await fetchJson('/employeeTypes');
    STATE.allEmployeeTypes = data.sort();
    const container = document.getElementById('employeeTypeGroup');
    container.innerHTML = '';
    STATE.allEmployeeTypes.forEach(emp=>{
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.value = emp;
        input.checked = true;
        input.classList.add('employee-checkbox');
        label.appendChild(input);
        label.appendChild(document.createTextNode(emp));
        container.appendChild(label);
    });
}

function getCheckedEmployeeTypes(){
    const checkboxes = Array.from(document.querySelectorAll('#employeeTypeGroup input.employee-checkbox'));
    const checked = checkboxes.filter(b => b.checked).map(b => b.value);
    return checked.length === checkboxes.length ? null : checked;
}

function getCheckedValues(containerId){
    return Array.from(document.getElementById(containerId).querySelectorAll('input:checked')).map(i=>i.value);
}

// ------------------------
// APPLY BUTTON: LOAD DATA
// ------------------------
document.getElementById('applyButton').addEventListener('click', async () => {
    const selectedEventTypes = getCheckedValues('eventTypeGroup');
    if(selectedEventTypes.length===0) return;

    const selectedEmployees = getCheckedEmployeeTypes();
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    STATE.fullEvents = [];
    STATE.eventTypeOrder = [];

    for(const eventType of selectedEventTypes){
        const params = new URLSearchParams();
        params.append('inputEventType', eventType);
        if(startDate) params.append('startTime', startDate+'T00:00:00');
        if(endDate) params.append('endTime', endDate+'T23:59:59');
        if(selectedEmployees) selectedEmployees.forEach(emp => params.append('employeeType', emp));

        const url = `/data?${params.toString()}`;
        const data = await fetchJson(url);

        const events = data.events.map(ev=>({
            eventType,
            user: ev.user_name ?? "unknown",
            selection: String(Object.values(ev.payload)[0] ?? "unknown"),
            employee_type: ev.employee_type ?? "unknown",
            count: ev.count ?? 0
        }));

        STATE.fullEvents.push(...events);
        STATE.eventTypeOrder.push(eventType);
    }

    STATE.eventTypeOrder = [...new Set(STATE.eventTypeOrder)];
    renderTableAndCharts();
});

// ------------------------
// BUILD PER-USER DATA
// ------------------------
function buildPerUser(events){
    const perUser = {};
    const totals = {};
    events.forEach(e => totals[e.user] = (totals[e.user]??0)+e.count);
    STATE.activeUsers = Object.keys(totals).filter(u=>totals[u]>0).sort();
    STATE.userOrder = [...STATE.activeUsers];

    STATE.activeUsers.forEach(u => perUser[u] = {});
    events.forEach(e => {
        if(totals[e.user]>0)
            perUser[e.user][`${e.eventType}::${e.selection}`] =
                (perUser[e.user][`${e.eventType}::${e.selection}`]??0)+e.count;
    });
    return perUser;
}

function getSelections(perUser) {
    return [...new Set(Object.keys(perUser).flatMap(u=>Object.keys(perUser[u])))].sort();
}

// ------------------------
// DRAW BIG TABLE
// ------------------------
function drawTable(perUser,selections){
    const table = document.getElementById('bigTable');
    const thead = document.querySelector('#bigTable thead');
    const tbody = document.querySelector('#bigTable tbody');
    thead.innerHTML='';
    tbody.innerHTML='';

    const headerRow = document.createElement('tr');
    ['Operation','MOST USED','AVERAGE','TOTAL',...STATE.userOrder].forEach(text=>{
        const th = document.createElement('th');
        th.classList.add('rotate','sticky');
        const div = document.createElement('div');
        div.textContent=text;
        th.appendChild(div);
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    STATE.eventTypeOrder.forEach((eventType, idx)=>{
        const eventSelections = selections.filter(s=>s.startsWith(eventType+'::'));
        const rowClass = idx%2===0?'eventtype-row-white':'eventtype-row-gray';

        const columnMax = {};
        STATE.userOrder.forEach(u=>{
            columnMax[u]=Math.max(...eventSelections.map(sel=>perUser[u]?.[sel]??0),0);
        });

        eventSelections.forEach(sel=>{
            const tr = document.createElement('tr');
            tr.classList.add('sortable',rowClass);
            const displayName = sel.split('::')[1];
            tr.dataset.operation = displayName;

            tr.appendChild(createCell(displayName,false,null,'operation-cell'));

            const total = STATE.userOrder.reduce((sum,u)=>sum+(perUser[u]?.[sel]??0),0);
            const avg = STATE.userOrder.length ? (total/STATE.userOrder.length).toFixed(2) : 0;

            let mostUsed = 0;
            STATE.userOrder.forEach(u=>{
                if((perUser[u]?.[sel]??0)===columnMax[u] && columnMax[u]>0) mostUsed++;
            });

            tr.appendChild(createCell(mostUsed,false,null,'summary-cell'));
            tr.appendChild(createCell(avg,false,null,'summary-cell'));
            tr.appendChild(createCell(total,false,null,'summary-cell'));

            STATE.userOrder.forEach(u=>{
                const val = perUser[u]?.[sel]??0;
                const td = createCell(val,false,null,'user-cell');
                if(val>0 && val===columnMax[u]) td.classList.add('heatmap-max');
                tr.appendChild(td);
            });

            tr.addEventListener('click',()=>sortTableByRow(table,tr,STATE.rowSortStates,4));
            tbody.appendChild(tr);
        });
    });

    applyStickyColumns(table,4);
}

// ------------------------
// RENDER TABLE + CHARTS
// ------------------------
function renderTableAndCharts(){
    const perUser = buildPerUser(STATE.fullEvents);
    const selections = getSelections(perUser);
    drawTable(perUser,selections);

    const showPercentage = document.getElementById('percentageToggle')?.checked ?? false;
    const chartContainer = document.getElementById('multiChartContainer');

    // Charts: split max 2 per row
    chartContainer.style.display='grid';
    chartContainer.style.gridTemplateColumns='repeat(2, 1fr)';
    chartContainer.style.gap='20px';

    renderMultipleBarCharts(chartContainer, perUser, STATE.eventTypeOrder, COLORS, showPercentage);
}


// INITIAL LOAD
loadEventTypes();
loadEmployeeTypes();

</script>

</body>
</html>
