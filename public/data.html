<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Event Pool Viewer</title>
<link rel="stylesheet" href="styles/styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="scripts/utils.js"></script>
</head>
<body>

<header>
    <div class="navbar">
        <a href="index.html"><img src="images/ticra.png" alt="Home" class="nav-icon"></a>
        <a href="session.html">Sessions</a>
    </div>
</header>

<h1>Event Pool Viewer</h1>

<div id="filters">
    <label>Event type:
        <select id="eventType"><option value="">Select event</option></select>
    </label>

    <label>Employee type:
        <select id="employeeType"><option value="">All</option></select>
    </label>

    <label>Start date:
        <input type="date" id="startDate">
    </label>

    <label>End date:
        <input type="date" id="endDate">
    </label>

    <button id="applyButton">Apply</button>
</div>

<div id="tableContainerWrapper">
    <div id="tableContainer">
        <table id="bigTable">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="totalChartContainer">
    <canvas id="totalChart"></canvas>
</div>

<footer>
    Â© TICRA foundation
</footer>

<script type="module">
import { COLORS, setDefaultDateRange, fetchJson, populateDropdown, createHeader, createCell, applyHeatmap, sortTableByRow, renderBarChart, applyStickyColumns } from './scripts/utils.js';

const STATE = {
    fullEvents: [],
    filteredEvents: [],
    activeUsers: [],
    userOrder: [],
    rowSortStates: {}
};

setDefaultDateRange('startDate','endDate',10);
populateDropdown('eventType','/eventQueries','Select event');

document.getElementById('applyButton').addEventListener('click', loadData);
document.getElementById('employeeType').addEventListener('change', applyFilters);
document.getElementById('eventType').addEventListener('change', () => {
    document.getElementById('employeeType').value = '';
});

// Create rotated header
function createRotatedHeader(text){
    const th = document.createElement('th');
    th.classList.add('rotate', 'sticky'); // sticky will be applied later
    const div = document.createElement('div');
    div.textContent = text;
    th.appendChild(div);
    return th;
}

async function loadData(){
    const eventType = document.getElementById('eventType').value;
    if(!eventType) return;

    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    let url = `/data?inputEventType=${encodeURIComponent(eventType)}`;
    if(startDate) url += `&startTime=${encodeURIComponent(startDate+'T00:00:00')}`;
    if(endDate) url += `&endTime=${encodeURIComponent(endDate+'T23:59:59')}`;

    const data = await fetchJson(url);

    STATE.fullEvents = data.events.map(ev => ({
        user: ev.user_name ?? "unknown",
        selection: String(Object.values(ev.payload)[0] ?? "unknown"),
        employee_type: ev.employee_type ?? "unknown",
        count: ev.count ?? 0
    }));

    populateEmployeeTypes();
    applyFilters();
}

function populateEmployeeTypes() {
    const sel = document.getElementById('employeeType');
    const current = sel.value;
    const types = [...new Set(STATE.fullEvents.map(e=>e.employee_type).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">All</option>';
    types.forEach(t => sel.appendChild(new Option(t,t)));
    if(types.includes(current)) sel.value = current;
}

function applyFilters() {
    const emp = document.getElementById('employeeType').value;
    STATE.filteredEvents = STATE.fullEvents.filter(ev => !emp || ev.employee_type === emp);
    renderTableAndChart();
}

function buildPerUser(events){
    const perUser = {};
    const totals = {};
    events.forEach(e => totals[e.user] = (totals[e.user]??0)+e.count);
    STATE.activeUsers = Object.keys(totals).filter(u=>totals[u]>0).sort();
    STATE.userOrder = [...STATE.activeUsers];

    STATE.activeUsers.forEach(u => perUser[u] = {});
    events.forEach(e => {
        if(totals[e.user]>0) perUser[e.user][e.selection] = (perUser[e.user][e.selection]??0)+e.count;
    });
    return perUser;
}

function getSelections(perUser) {
    return [...new Set(Object.keys(perUser).flatMap(u=>Object.keys(perUser[u])))].sort();
}

function calculateColumnMax(perUser, selections) {
    const maxValues = {};
    STATE.userOrder.forEach(u => maxValues[u] = Math.max(...selections.map(s => perUser[u]?.[s]??0),0));
    return maxValues;
}

function drawTable(perUser,selections){
    const thead = document.querySelector('#bigTable thead');
    const tbody = document.querySelector('#bigTable tbody');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    const headerRow = document.createElement('tr');

    // First 4 sticky columns: Operation, MOST USED, AVERAGE, TOTAL
    headerRow.appendChild(createRotatedHeader('Operation'));
    headerRow.appendChild(createRotatedHeader('MOST USED'));
    headerRow.appendChild(createRotatedHeader('AVERAGE'));
    headerRow.appendChild(createRotatedHeader('TOTAL'));

    STATE.userOrder.forEach(u => headerRow.appendChild(createRotatedHeader(u)));
    thead.appendChild(headerRow);

    const columnMax = calculateColumnMax(perUser,selections);

    selections.forEach(sel=>{
        const tr = document.createElement('tr');
        tr.classList.add('sortable');
        tr.dataset.operation = sel;

        tr.appendChild(createCell(sel,false,'','operation-cell'));

        // MOST USED
        let total=0;
        STATE.userOrder.forEach(u=>total += perUser[u]?.[sel]??0);

        const avg = STATE.userOrder.length ? (total/STATE.userOrder.length).toFixed(2) : 0;

        let mostUsed=0;
        STATE.userOrder.forEach(u=>{
            const userMax = Math.max(...selections.map(s=>perUser[u]?.[s]??0));
            if((perUser[u]?.[sel]??0)===userMax && userMax>0) mostUsed++;
        });

        tr.appendChild(createCell(mostUsed,true));
        tr.appendChild(createCell(avg,true));
        tr.appendChild(createCell(total,true));

        // User columns
        STATE.userOrder.forEach(u=>{
            const val = perUser[u]?.[sel]??0;
            tr.appendChild(createCell(val,false,cellColor(val,columnMax[u])));
        });

        tr.addEventListener('click',()=>sortTableByRow(document.querySelector('#bigTable'),tr,STATE.rowSortStates));
        tbody.appendChild(tr);
    });

    applyHeatmap('#bigTable');

    // Make first 4 columns sticky
    applyStickyColumns(document.querySelector('#bigTable'), 4);
}

function cellColor(value,max){ 
    const g = max>0?Math.round(255-(value/max)*100):255;
    return `rgb(${g},255,${g})`;
}

function renderTableAndChart(){
    const perUser = buildPerUser(STATE.filteredEvents);
    const selections = getSelections(perUser);
    drawTable(perUser,selections);

    const totals = selections.map(sel=>STATE.userOrder.reduce((sum,u)=>sum+(perUser[u]?.[sel]??0),0));
    renderBarChart(document.getElementById('totalChart'), selections, totals, COLORS, {plugins:{legend:{position:'bottom'}}, responsive:false, animation:false});
}
</script>

</body>
</html>
