<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clicks by Operation </title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; text-align: center; table-layout: fixed; }
  th, td { border: 1px solid #ccc; padding: 5px; vertical-align: top; }
  th { background-color: #f0f0f0; }
  .chart-container { width: 80px; height: 80px; margin: auto; }
  .legend { margin: 20px 0; }
  .legend-item { display: inline-block; margin-right: 15px; }
  .legend-color { width: 15px; height: 15px; display: inline-block; margin-right: 5px; vertical-align: middle; }
</style>
</head>
<body>
<h1>Clicks by Operation</h1>

<div class="legend" id="legend"></div>

<table id="bigTable">
  <thead>
    <tr id="chartRow">
      <th>Operation</th>
    </tr>
    <tr id="labelRow">
      <th></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function loadData() {
  const res = await fetch('/create');
  const data = await res.json();

  const users = Object.keys(data.perUser).sort();
  const operations = data.averages.map(a => a.operation);

  const chartRow = document.getElementById('chartRow');
  const labelRow = document.getElementById('labelRow');

  // ---------- Prepare colors ----------
  const colors = ['#4caf50', '#2196f3', '#ff9800', '#f44336', '#9c27b0', '#00bcd4', '#ffeb3b', '#795548'];

  // ---------- Generate legend ----------
  const legendDiv = document.getElementById('legend');
  legendDiv.innerHTML = '';
  operations.forEach((op, i) => {
    const item = document.createElement('div');
    item.classList.add('legend-item');
    const colorBox = document.createElement('span');
    colorBox.classList.add('legend-color');
    colorBox.style.backgroundColor = colors[i % colors.length];
    item.appendChild(colorBox);
    item.appendChild(document.createTextNode(op));
    legendDiv.appendChild(item);
  });

  // ---------- Average column ----------
  const avgCanvasTh = document.createElement('th');
  const avgCanvas = document.createElement('canvas');
  avgCanvas.classList.add('chart-container');
  avgCanvasTh.appendChild(avgCanvas);
  chartRow.appendChild(avgCanvasTh);

  const avgLabelTh = document.createElement('th');
  avgLabelTh.textContent = 'Average';
  labelRow.appendChild(avgLabelTh);

  const avgData = operations.map(op => {
    const avgObj = data.averages.find(a => a.operation === op);
    return avgObj ? parseFloat(avgObj.avg_clicks_per_user.toFixed(2)) : 0;
  });

  new Chart(avgCanvas.getContext('2d'), {
    type: 'pie',
    data: { labels: operations, datasets: [{ data: avgData, backgroundColor: operations.map((_, i) => colors[i % colors.length]) }] },
    options: { plugins: { legend: { display: false } }, responsive: false, animation: { duration: 0 } }
  });

  // ---------- Calculate per-user max for heatmap ----------
  const userMaxClicks = {};
  users.forEach(user => {
    const userData = (data.perUser[user] || []).map(opObj => opObj.clicks);
    userMaxClicks[user] = userData.length ? Math.max(...userData) : 1; // avoid divide by zero
  });

  // ---------- User columns ----------
  users.forEach((user, idx) => {
    // Pie chart cell
    const thChart = document.createElement('th');
    const canvas = document.createElement('canvas');
    canvas.classList.add('chart-container');
    thChart.appendChild(canvas);
    chartRow.appendChild(thChart);

    // Label cell
    const thLabel = document.createElement('th');
    thLabel.textContent = user;
    labelRow.appendChild(thLabel);

    // Pie chart for user
    const userData = operations.map(op => {
      const userOps = data.perUser[user] || [];
      const opObj = userOps.find(o => o.operation === op);
      return opObj ? opObj.clicks : 0;
    });

    new Chart(canvas.getContext('2d'), {
      type: 'pie',
      data: { labels: operations, datasets: [{ data: userData, backgroundColor: operations.map((_, i) => colors[i % colors.length]) }] },
      options: { plugins: { legend: { display: false } }, responsive: false, animation: { duration: 0 } }
    });
  });

  // ---------- Build table body ----------
  const tbody = document.querySelector('#bigTable tbody');
  tbody.innerHTML = '';

  operations.forEach(op => {
    const tr = document.createElement('tr');

    // Operation column
    const tdOp = document.createElement('td');
    tdOp.textContent = op;
    tr.appendChild(tdOp);

    // Average column
    const tdAvg = document.createElement('td');
    const avgObj = data.averages.find(a => a.operation === op);
    tdAvg.textContent = avgObj ? avgObj.avg_clicks_per_user.toFixed(2) : '0';
    tr.appendChild(tdAvg);

    // User columns with per-user dynamic heatmap
    users.forEach(user => {
      const td = document.createElement('td');
      const userOps = data.perUser[user] || [];
      const opObj = userOps.find(o => o.operation === op);
      const clicks = opObj ? opObj.clicks : 0;
      td.textContent = clicks;

      // ---------- Per-user normalized intensity ----------
      const maxClicks = userMaxClicks[user];
      const intensity = clicks / maxClicks; // 0 → 1 per user

      // Interpolate white → light green → green
      let r, g, b;
      if (intensity < 0.5) {
        const t = intensity / 0.5;
        r = Math.round(255 - t * (255 - 220));
        g = Math.round(255 - t * (255 - 255));
        b = Math.round(255 - t * (255 - 220));
      } else {
        const t = (intensity - 0.5) / 0.5;
        r = Math.round(220 - t * (220 - 150));
        g = Math.round(255 - t * (255 - 230));
        b = Math.round(220 - t * (220 - 150));
      }

      td.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
      td.style.color = 'black'; // always readable

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

loadData();
</script>
</body>
</html>
